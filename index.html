<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirKid Companion</title>
    <script src="puzzles.js"></script>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --primary: #2c3e50;
            --accent: #3498db;
            --piece-red: #e74c3c;
            --piece-green: #2ecc71;       
            --piece-lightgreen: #b8e994;  
            --piece-orange: #e67e22;
            --cell-size: 55px; 
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden;
        }

        h1 { margin: 5px 0 15px 0; font-size: 1.5rem; color: var(--primary); }
        
        .app-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        /* --- LANDSCAPE OPTIMIZATION FOR IPAD --- */
        @media (min-width: 768px) and (orientation: landscape) {
            h1 { display: none; } 
            .app-container {
                max-width: 90%;
                height: 90vh;
                justify-content: center;
            }
            .card {
                flex-direction: row; 
                justify-content: space-around;
                padding: 40px;
                gap: 40px;
            }
            .card-left { flex: 1; display: flex; justify-content: center; }
            .card-right { 
                flex: 0.8; 
                display: flex; 
                flex-direction: column; 
                justify-content: center; 
                align-items: center;
                height: 100%;
            }
            .controls-wrapper { order: 2; margin-top: 30px; width: 100%; }
        }

        @media (orientation: portrait) {
            .card-right { width: 100%; }
            .controls-wrapper { width: 100%; max-width: 500px; margin-bottom: 15px; }
        }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        button {
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
            overflow: hidden;
        }

        button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
        }

        #prevBtn {
            background-color: #bdc3c7;
            color: #2c3e50;
            padding: 12px 20px;
            font-size: 1rem;
        }

        #nextBtn {
            background-color: var(--accent);
            color: white;
            padding: 15px 40px;
            font-size: 1.4rem;
            flex-grow: 0.5;
            margin-left: 15px;
            background: linear-gradient(to bottom, #3498db, #2980b9);
        }
        
        #nextBtn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; transform: none; }
        #prevBtn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- BOARD --- */
        .instruction {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 20px;
            background: #eef2f7;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .board-wrapper {
            background: #2c3e50; 
            padding: 15px;
            border-radius: 12px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
            display: inline-block;
        }

        .grid { display: grid; gap: 4px; }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: #ecf0f1; 
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .piece-start, .piece-end {
            width: 90%; height: 90%; background-color: var(--piece-red);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 0 #c0392b;
        }
        .dir-arrow { font-size: 32px; color: white; font-weight: 900; line-height: 1; display: block; }
        .flag { font-size: 28px; }

        .rot-N  { transform: rotate(0deg); } .rot-NE { transform: rotate(45deg); } .rot-E  { transform: rotate(90deg); }
        .rot-SE { transform: rotate(135deg); } .rot-S  { transform: rotate(180deg); } .rot-SW { transform: rotate(225deg); }
        .rot-W  { transform: rotate(270deg); } .rot-NW { transform: rotate(315deg); }

        /* --- ACCESSORIES --- */
        .level-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 20px;
            display: block;
        }

        h3 { margin: 20px 0 10px 0; color: var(--primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .accessories {
            display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
        }

        .acc-item {
            display: flex; flex-direction: column; align-items: center;
            background: #f8f9fa; padding: 10px; border-radius: 15px;
            border: 2px solid #e1e8ed; width: 70px;
            box-shadow: 0 4px 0 #e1e8ed;
        }

        .acc-icon { width: 35px; height: 35px; margin-bottom: 8px; }

        .shape-green { background-color: var(--piece-green); clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%); }
        .shape-yellow { background-color: var(--piece-lightgreen); border-radius: 50%; border-bottom-left-radius: 0; }
        .shape-orange { background-color: var(--piece-orange); border-radius: 50%; }

        .acc-count { font-weight: 800; font-size: 1.6rem; color: #2c3e50; }
        .acc-label { font-size: 0.75rem; color: #7f8c8d; margin-top: 4px; font-weight: bold;}
        
        .edit-link { margin-top: 30px; font-size: 0.8rem; color: #aaa; text-decoration: none; position: relative; z-index: 10; }

        /* --- EXPLOSION PARTICLES --- */
        .emoji-particle {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            /* Animation handles float, scale, and rotate */
            animation: float-out 1.2s ease-out forwards;
        }

        @keyframes float-out {
            0% { 
                transform: translate(0, 0) scale(0.2) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(var(--rot)); 
                opacity: 0; 
            }
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="controls-wrapper">
             <h1>AirKid Companion</h1>
            <div class="controls">
                <button id="prevBtn" onclick="app.prev()">Back</button>
                <button id="nextBtn" onclick="app.next(event)">Next Level ‚ûú</button>
            </div>
        </div>

        <div class="card">
            
            <div class="card-left">
                <div style="text-align:center;">
                    <div id="boardInstruction" class="instruction">Loading...</div>
                    <div class="board-wrapper">
                        <div id="grid" class="grid"></div>
                    </div>
                </div>
            </div>

            <div class="card-right">
                <span class="level-title">Level <span id="levelNum">1</span></span>
                
                <h3>Parts Needed</h3>
                <div id="accessories" class="accessories"></div>
            </div>

        </div>

        <a href="editor.html" class="edit-link">Parent Editor</a>
    </div>

<script>
const app = (function() {
    let levels = window.PUZZLE_DATA || [];
    let currentIndex = 0;

    function init() {
        if(levels.length === 0) {
            document.body.innerHTML = "<h1>Error: puzzles.js not found</h1>";
            return;
        }
        try {
            const saved = localStorage.getItem('airkid_level');
            if (saved) {
                const foundIndex = levels.findIndex(l => l.id == saved);
                if (foundIndex !== -1) currentIndex = foundIndex;
            }
        } catch (e) {}
        render();
    }

    function changeLevel(delta, event) {
        if (delta > 0 && event) {
            triggerExplosion(event.clientX, event.clientY);
        }

        const newIndex = currentIndex + delta;
        if (newIndex >= 0 && newIndex < levels.length) {
            currentIndex = newIndex;
            setTimeout(() => {
                render();
            }, delta > 0 ? 150 : 0);
            
            try { localStorage.setItem('airkid_level', levels[currentIndex].id); } catch(e){}
        }
    }

    function triggerExplosion(x, y) {
        const emojis = ['üéâ', 'üöÄ', '‚≠ê', 'üê∂', 'üçï', 'ü§ñ', 'üöó', 'üåà', 'üî•', '‚ú®', 'üèÜ', 'üíØ'];
        const particleCount = 60; // MORE particles

        for (let i = 0; i < particleCount; i++) {
            const el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.className = 'emoji-particle';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            
            // Random Size
            const size = 20 + Math.random() * 40 + 'px'; 
            el.style.fontSize = size;

            // Random Angle & Velocity
            const angle = Math.random() * Math.PI * 2;
            const velocity = 100 + Math.random() * 500; // Much further throw
            
            const tx = Math.cos(angle) * velocity + 'px';
            const ty = Math.sin(angle) * velocity + 'px';
            
            // Random Rotation
            const rot = (Math.random() * 720 - 360) + 'deg';
            
            el.style.setProperty('--tx', tx);
            el.style.setProperty('--ty', ty);
            el.style.setProperty('--rot', rot);
            
            document.body.appendChild(el);
            
            setTimeout(() => el.remove(), 1200);
        }
    }

    function render() {
        const data = levels[currentIndex];
        const isSquare = data.type === 'square';
        const cols = isSquare ? 4 : 6;
        const rows = 4;

        document.getElementById('levelNum').innerText = data.id;
        document.getElementById('prevBtn').disabled = (currentIndex === 0);
        const nextBtn = document.getElementById('nextBtn');
        nextBtn.disabled = (currentIndex === levels.length - 1);
        nextBtn.innerText = (currentIndex === levels.length - 1) ? "Done!" : "Next Level ‚ûú";
        
        let instr = isSquare ? "Setup: Square (4x4)" : "Setup: Rectangle (6x4)";
        document.getElementById('boardInstruction').innerText = instr;

        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';

                if (data.start && c === data.start.col && r === data.start.row) {
                    cell.innerHTML = `<div class="piece-start"><span class="dir-arrow rot-${data.start.dir}">‚¨Ü</span></div>`;
                }
                
                if (data.end && c === data.end.col && r === data.end.row) {
                    cell.innerHTML = `<div class="piece-end"><span class="flag">üèÅ</span></div>`;
                }
                grid.appendChild(cell);
            }
        }

        const accBox = document.getElementById('accessories');
        accBox.innerHTML = '';
        const types = [
            { key: 'green', color: 'green', label: 'Cross' },
            { key: 'yellow', color: 'yellow', label: 'L. Green' },
            { key: 'orange', color: 'orange', label: 'Arc' }
        ];

        types.forEach(t => {
            const count = data.pieces[t.key];
            if (count > 0) {
                const item = document.createElement('div');
                item.className = 'acc-item';
                item.innerHTML = `<div class="acc-icon shape-${t.color}"></div><span class="acc-count">x${count}</span><span class="acc-label">${t.label}</span>`;
                accBox.appendChild(item);
            }
        });
    }

    init();

    return { next: (e) => changeLevel(1, e), prev: () => changeLevel(-1) };
})();
</script>
</body>
</html>