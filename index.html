<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirKid Companion</title>
    <script src="puzzles.js"></script>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --primary: #2c3e50;
            --accent: #3498db;
            --piece-red: #e74c3c;
            --piece-green: #2ecc71;
            --piece-yellow: #f1c40f;
            --piece-orange: #e67e22;
            --cell-size: 55px; 
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }

        h1 { margin: 10px 0; font-size: 1.5rem; color: var(--primary); }
        
        .controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            margin-bottom: 15px;
            align-items: center;
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .level-display {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .instruction {
            font-size: 1rem;
            color: #555;
            margin-bottom: 15px;
            background: #eef2f7;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .board-wrapper {
            background: #2c3e50; 
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }

        .grid {
            display: grid;
            gap: 4px;
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: #ecf0f1; 
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .piece-start {
            width: 90%; height: 90%; background-color: var(--piece-red);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 0 #c0392b;
        }

        .dir-arrow {
            font-size: 32px; color: white; font-weight: 900; line-height: 1;
            display: block;
        }

        .piece-end {
            width: 90%; height: 90%; background-color: var(--piece-red);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 0 #c0392b;
        }
        .flag { font-size: 28px; }

        .rot-N  { transform: rotate(0deg); }
        .rot-NE { transform: rotate(45deg); }
        .rot-E  { transform: rotate(90deg); }
        .rot-SE { transform: rotate(135deg); }
        .rot-S  { transform: rotate(180deg); }
        .rot-SW { transform: rotate(225deg); }
        .rot-W  { transform: rotate(270deg); }
        .rot-NW { transform: rotate(315deg); }

        h3 { margin: 0 0 10px 0; color: var(--primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .accessories {
            display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;
        }

        .acc-item {
            display: flex; flex-direction: column; align-items: center;
            background: #f8f9fa; padding: 10px; border-radius: 12px;
            border: 2px solid #e1e8ed; width: 70px;
        }

        .acc-icon { width: 32px; height: 32px; margin-bottom: 6px; }

        .shape-green { background-color: var(--piece-green); clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%); }
        .shape-yellow { background-color: var(--piece-yellow); border-radius: 50%; border-bottom-left-radius: 0; }
        .shape-orange { background-color: var(--piece-orange); border-radius: 50%; }

        .acc-count { font-weight: 800; font-size: 1.4rem; color: #2c3e50; }
        .acc-label { font-size: 0.7rem; color: #7f8c8d; margin-top: 2px; }
        
        .edit-link { margin-top: 30px; font-size: 0.8rem; color: #aaa; text-decoration: none; }

        @media (max-width: 400px) {
            :root { --cell-size: 45px; }
            .acc-item { width: 60px; }
        }
    </style>
</head>
<body>

    <h1>AirKid Companion</h1>

    <div class="controls">
        <button id="prevBtn" onclick="app.prev()">Back</button>
        <div class="level-display">Level <span id="levelNum">1</span></div>
        <button id="nextBtn" onclick="app.next()">Next</button>
    </div>

    <div class="card">
        <div id="boardInstruction" class="instruction">Loading...</div>
        <div class="board-wrapper">
            <div id="grid" class="grid"></div>
        </div>
        <h3>Parts List</h3>
        <div id="accessories" class="accessories"></div>
    </div>
    
    <a href="editor.html" class="edit-link">Parent Editor</a>

<script>
const app = (function() {
    let levels = window.PUZZLE_DATA || [];
    let currentIndex = 0;

    function init() {
        if(levels.length === 0) {
            document.body.innerHTML = "<h1>Error: puzzles.js not found</h1>";
            return;
        }
        try {
            const saved = localStorage.getItem('airkid_level');
            if (saved) {
                const foundIndex = levels.findIndex(l => l.id == saved);
                if (foundIndex !== -1) currentIndex = foundIndex;
            }
        } catch (e) {}
        render();
    }

    function changeLevel(delta) {
        const newIndex = currentIndex + delta;
        if (newIndex >= 0 && newIndex < levels.length) {
            currentIndex = newIndex;
            render();
            try { localStorage.setItem('airkid_level', levels[currentIndex].id); } catch(e){}
        }
    }

    function render() {
        const data = levels[currentIndex];
        const isSquare = data.type === 'square';
        const cols = isSquare ? 4 : 6;
        const rows = 4;

        document.getElementById('levelNum').innerText = data.id;
        document.getElementById('prevBtn').disabled = (currentIndex === 0);
        document.getElementById('nextBtn').disabled = (currentIndex === levels.length - 1);
        
        let instr = isSquare ? "Setup: Square (4x4)" : "Setup: Rectangle (6x4)";
        document.getElementById('boardInstruction').innerText = instr;

        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';

                if (data.start && c === data.start.col && r === data.start.row) {
                    cell.innerHTML = `<div class="piece-start"><span class="dir-arrow rot-${data.start.dir}">‚¨Ü</span></div>`;
                }
                
                if (data.end && c === data.end.col && r === data.end.row) {
                    cell.innerHTML = `<div class="piece-end"><span class="flag">üèÅ</span></div>`;
                }
                grid.appendChild(cell);
            }
        }

        const accBox = document.getElementById('accessories');
        accBox.innerHTML = '';
        const types = [
            { key: 'green', color: 'green', label: 'Cross' },
            { key: 'yellow', color: 'yellow', label: 'Bend' },
            { key: 'orange', color: 'orange', label: 'Arc' }
        ];

        types.forEach(t => {
            const count = data.pieces[t.key];
            if (count > 0) {
                const item = document.createElement('div');
                item.className = 'acc-item';
                item.innerHTML = `<div class="acc-icon shape-${t.color}"></div><span class="acc-count">x${count}</span><span class="acc-label">${t.label}</span>`;
                accBox.appendChild(item);
            }
        });
    }

    init();

    return { next: () => changeLevel(1), prev: () => changeLevel(-1) };
})();
</script>
</body>
</html>